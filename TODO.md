# TODO

## mediasoup-client-aiortc

* Fill `README.md`.

* Why is there a `Handler` class in `worker.py` and why does requests and notifications call `handler.xxx()` instead of directly doing the stuff? Do we really need such a `Handler` class and `handler` singleton?
  - __main__ creates a `Channel` (instance) and a `Handler` (instance) and calls `run(channel, handler)`. `run` is just responsible of receiving requests, checking the requests arguments, calling corresponding `Handler` instance, retrieving the result of the method and sending back to the channel. I find good reason for having `Handler` and `Channel` clases.

* Internal track ID does not correspond with track ID in remote offer:


```txt
The following SDP of type 'offer' is set via pc.setRemoteDescription()

v=0
o=mediasoup-client 10000 1 IN IP4 0.0.0.0
s=-
t=0 0
a=ice-lite
a=fingerprint:sha-256 A9:46:9A:9A:C2:F4:6B:CB:EC:DD:9F:0B:BF:00:A7:A9:76:59:3E:EB:16:A4:A6:D9:40:1A:BE:DC:71:85:71:04
a=msid-semantic: WMS *
a=group:BUNDLE 0
m=audio 7 UDP/TLS/RTP/SAVPF 100
c=IN IP4 127.0.0.1
a=rtpmap:100 opus/48000/2
a=fmtp:100 minptime=10;useinbandfec=1;sprop-stereo=1;usedtx=1
a=extmap:4 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time
a=setup:actpass
a=mid:0
a=msid:YeZ9atr3+L+AdIqE 19fe488f-c936-4ae3-91b6-3947ee95ae4f
a=sendonly
a=ice-ufrag:4apu7crrnycj2cpr
a=ice-pwd:lz2j0tcwk71obtusaszklel15w690e3h
a=candidate:udpcandidate 1 udp 1076302079 10.0.0.1 40029 typ host
a=end-of-candidates
a=ice-options:renomination
a=ssrc:963935251 cname:YeZ9atr3+L+AdIqE
a=rtcp-mux
a=rtcp-rsize

As a result, pc "track" event is fired with the following information:

ontrack [kind:audio, id:1ba7eef1-022f-469f-9ce0-f0d6bad91ba5]
```

* DataChannel.
  - No "error" event implemented in aiortc.
  - "message" events generated by aiortc are not wrapped into a `MessageEvent` but, instead, the "message" event is emitted with a `data` argument that may be a string or a binary. Take it into consideration.
  - We do not update `dc.bufferedAmount` in JS. We may notify its native value from py to JS for each sent message, received message, 'bufferedamountlow' event, etc. 
  - Let's figure out how to deal with binary messages for sending and receiving, we should encode them somehow to JSON serializable text, i.e. base64:

```python
>>> empty_bytes = bytes(4)
>>> type(empty_bytes).__name__
'bytes'

>>> foo = "hehe"
>>> type(foo).__name__
'str'
```

  - Let's figure out how to deal with `binaryType` stuff (aiortc does not implement it since it just makes sense in JS).
  - Need tests.
  - Eventually I got this (before fixing the "open" event stuff so it may never happen again):

```
terminal> roomClient._chatDataProducer.readyState
'open'


terminal> roomClient.sendChatMessage("CHAT")
  mediasoup-client:RoomClient sendChatMessage() [text:"CHAT] +12m
  mediasoup-client:DataProducer send() +12m
  mediasoup-client:aiortc:Channel notify() [event:datachannel.send] +12m
Promise { undefined }
terminal>   mediasoup-client:aiortc:Worker (stdout) Task exception was never retrieved +12m
  mediasoup-client:aiortc:Worker (stdout) future: <Task finished coro=<RTCSctpTransport._data_channel_flush() done, defined at /usr/local/lib/python3.7/site-packages/aiortc/rtcsctptransport.py:1604> exception=ConnectionError('Cannot send encrypted data, not connected')> +0ms
  mediasoup-client:aiortc:Worker (stdout) Traceback (most recent call last): +1ms
  mediasoup-client:aiortc:Worker (stdout)   File "/usr/local/lib/python3.7/site-packages/aiortc/rtcsctptransport.py", line 1642, in _data_channel_flush +0ms
  mediasoup-client:aiortc:Worker (stdout)     ordered=channel.ordered, +0ms
  mediasoup-client:aiortc:Worker (stdout)   File "/usr/local/lib/python3.7/site-packages/aiortc/rtcsctptransport.py", line 1314, in _send +0ms
  mediasoup-client:aiortc:Worker (stdout)     await self._transmit() +0ms
  mediasoup-client:aiortc:Worker (stdout)   File "/usr/local/lib/python3.7/site-packages/aiortc/rtcsctptransport.py", line 1535, in _transmit +0ms
  mediasoup-client:aiortc:Worker (stdout)     await self._send_chunk(chunk) +0ms
  mediasoup-client:aiortc:Worker (stdout)   File "/usr/local/lib/python3.7/site-packages/aiortc/rtcsctptransport.py", line 1326, in _send_chunk +0ms
  mediasoup-client:aiortc:Worker (stdout)     chunk, +0ms
  mediasoup-client:aiortc:Worker (stdout)   File "/usr/local/lib/python3.7/site-packages/aiortc/rtcdtlstransport.py", line 658, in _send_data +0ms
  mediasoup-client:aiortc:Worker (stdout)     raise ConnectionError("Cannot send encrypted data, not connected") +0ms
  mediasoup-client:aiortc:Worker (stdout) ConnectionError: Cannot send encrypted data, not connected +0ms
```


* Use `sourceType` for files and URLs.


## aiortc

Things that must be verified, asked or even reported in aiortc project.

* `Aiortc.js` uses always `this._setupTransport({ localDtlsRole: 'server'` because aiortc fails to honor given DTLS role in the remote SDP offer and assumes it must always be 'server'.
  - Reported and explained: https://github.com/aiortc/aioice/issues/15

* Must report lack of `track.enabled = xxx` to pause sending RTP (or generate silence or black video with less bitrate).
  - Reported: https://github.com/aiortc/aiortc/issues/264
  - Store the legit track and replace the track `replaceTrack` with the base audio or video track.
