# TODO

## mediasoup-client-aiortc

* Must decide whether to use " or ' in Python files. Currently mixed.

* DataChannel.
  - No "error" event implemented in aiortc.
  - "message" events generated by aiortc are not wrapped into a `MessageEvent` but, instead, the "message" event is emitted with a `data` argument that may be a string or a binary. Take it into consideration.
  - Let's figure out how to deal with binary messages for sending and receiving, we should encode them somehow to JSON serializable text, i.e. base64.
  - Let's figure out how to deal with `binaryType` stuff (aiortc does not implement it since it just makes sense in JS).
  - "open" event for second DataChannel does not always reach JS land:

```
  protoo-client:Peer request() [method:produceData, id:1554545] +11ms
  mediasoup-client:ERROR:aiortc:Worker (stderr) TMP ----- dataChannel.readyState:open, label:bot +0ms
  mediasoup-client:DataProducer constructor() +2ms
roomClient.sendChatMessage("CHAT"); roomClient.sendBotMessage("BOT");
  mediasoup-client:RoomClient sendChatMessage() [text:"CHAT] +4s
  mediasoup-client:DataProducer send() +4s
  mediasoup-client:aiortc:Channel notify() [event:datachannel.send] +4s
  mediasoup-client:RoomClient sendBotMessage() [text:"BOT] +1ms
  mediasoup-client:DataProducer send() +1ms
  mediasoup-client:ERROR:RoomClient bot DataProducer.send() failed:InvalidStateError: not open at FakeRTCDataChannel.send (/Users/ibc/src/mediasoup-client-aiortc/lib/FakeRTCDataChannel.js:92:19) at DataProducer.send (/Users/ibc/src/v3-mediasoup-client/lib/DataProducer.js:124:27) at RoomClient.<anonymous> (/Users/ibc/src/v3-mediasoup-demo/aiortc/lib/RoomClient.js:822:39) at Generator.next (<anonymous>) at /Users/ibc/src/v3-mediasoup-demo/aiortc/lib/RoomClient.js:8:71 at new Promise (<anonymous>) at __awaiter (/Users/ibc/src/v3-mediasoup-demo/aiortc/lib/RoomClient.js:4:12) at RoomClient.sendBotMessage (/Users/ibc/src/v3-mediasoup-demo/aiortc/lib/RoomClient.js:815:16) at repl:1:48     at Script.runInThisContext (vm.js:116:20) { name: 'InvalidStateError' } +5s
Promise { undefined }
terminal> roomClient._botDataProducer.readyState
'connecting'
```

This is because the "open" event reaches JS **before** the `DataProducer` is created. Why? Because **before** the `DataProducer` is indexed into the mediasoup-client map of dataProducers, it must communicate with the server via "producedata" event and so on:

```js
const { id } = await this.safeEmitAsPromise(
  'producedata',
  {
    sctpStreamParameters,
    label,
    protocol,
    appData
  });

const dataProducer =
  new DataProducer({ id, dataChannel, sctpStreamParameters, appData });

this._dataProducers.set(dataProducer.id, dataProducer);
this._handleDataProducer(dataProducer);

return dataProducer;
```

* Use `sourceType` for files and URLs.


## aiortc

Things that must be verified, asked or even reported in aiortc project.

* If `rtcConfiguration` is given without `iceServers` or with empty `iceServers: []`, it fails. This is a BUG in aiortc.
  - Reported: https://github.com/aiortc/aiortc/issues/266

* Must verify max number of SCTP streams (`OS` and `MIS`). For instance it's `OS: 1024, MIS: 1024` in Chrome (cannot renegotiate it later) and `OS: 16, MIS: 2048` in Firefox (which does allow later renegotiation).
  - In https://github.com/aiortc/aiortc/blob/master/src/aiortc/rtcsctptransport.py:
    `MAX_STREAMS = 65535`, and it seems to support renegotiation.

* Must report lack of `track.enabled = xxx` to pause sending RTP (or generate silence or black video with less bitrate).
  - Reported: https://github.com/aiortc/aiortc/issues/264
  - Store the legit track and replace the track `replaceTrack` with the base audio or video track.

* Does only emit 'open' for the first DataChannel.
  - Solved by checking the state after replying to DataChannel creation request and notifying about it if by that time 'readyState' is 'open'

* Does mandate MaxRetransmits. Providing MaxPacketLifeTime and not the former results in error.
