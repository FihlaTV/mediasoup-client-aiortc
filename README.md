# mediasoup-client-aiortc

[mediasoup-client](https://github.com/versatica/mediasoup-client/) handler for [aiortc](https://github.com/aiortc/aiortc/) Python library. Suitable for building Node.js applications that connect to a mediasoup server using WebRTC and exchange real audio, video and DataChannel messages with it in both directions.


## Requirements

This module uses **aiortc** Python library, which needs Python 3 and these [requirements](https://github.com/aiortc/aiortc#requirements) to be installed in your system.


## Installation

Once the requirements above are satisfied, install **mediasoup-client-aiortc** within your Node.js application:

```bash
$ npm install --save mediasoup-client-aiortc
```

The "postinstall" script in `package.json` will install the Python libraries (including **aiortc**) by using `pip3` command. If such a command is not in the `PATH` or has a different name in your system, you can override its location by setting the `PIP3` environment variable:

```bash
$ PIP3=/home/me/bin/pip npm install --save mediasoup-client-aiortc
```


## API

```javascript
// ES6 style.
import {
  createFactory,
  WorkerLogLevel
} from 'mediasoup-client-aiortc';

// CommonJS style.
const {
  createFactory,
  WorkerLogLevel
} = require('mediasoup-client-aiortc');
```

#### `createFactory(logLevel: WorkerLogLevel = 'none'): HandlerFactory`

A function that creates a mediasoup-client handler factory, suitable for the [handlerFactory](https://mediasoup.org/documentation/v3/mediasoup-client/api/#Device-dictionaries) argument when instantiating a mediasoup-client [Device](https://mediasoup.org/documentation/v3/mediasoup-client/api/#mediasoupClient-Device).

```typescript
const device = new mediasoupClient.Device({
  handlerFactory: createFactory('warn')
});
```

Once you run your Node.js application, **mediasoup-client-aiortc** will spawn Python processes and communicate with them via UnixSocket. This module assumes that there is a `python3` executable in your `PATH` to spawn the Python executable. If not, you can override its location by setting the `PYTHON3` environment variable:

```bash
$ PYTHON3=/home/me/bin/python-3.7 node my_app.js
```

#### `WorkerLogLevel`

A TypeScript `type` to determine the logging verbosity of the Python component of the module ("none" by default).

```typescript
type WorkerLogLevel = 'debug' | 'warn' | 'error' | 'none';
```

Logs generated by both, Node.js and Python components of this module, are printed using the mediasoup-client [debugging](https://mediasoup.org/documentation/v3/mediasoup-client/debugging/) system with "mediasoup-client-aiortc" prefix/namespace.


## Audio and Video

**aiortc** Python library has the ability to generate `MediaStreamTracks` from the system microphone, webcam, a multimedia file or an HTTP stream. Those "tracks" just exist in Python land and hence we need a way to map them to/from Node.js.

**mediasoup-client-aiortc** requires that the `track` given to [transport.produce()](https://mediasoup.org/documentation/v3/mediasoup-client/api/#transport-produce) must be an instance of [FakeMediaStreamTrack](https://github.com/ibc/fake-mediastreamtrack) and its source must be indicated in the custom `track.data` object as follows:

#### `track.data.sourceType`

Determines which source **aiortc** will use to generate the audio or video track. These are the possible values:

* "device": System microphone or webcam (depending on `track.kind`).
* "file": Path to a multimedia file in the system.
* "url": URL of an HTTP stream.

#### `track.data.sourceValue`

Provides detailed information depending on `sourceType`:

* For "device" `sourceType`, `sourceValue` is optional and, if given, specifies the device ID of the microphone or webcam to use. If unset, the default one in the system will be used.
  - Default values for `Darwin` platform:
  - "none:0" for "audio" `kind`.
     - "default:none" for "video" `kind`.

  - Default values for `Linux` platform:
    - "hw:0" for "audio" `kind`.
    - "/dev/video0" for "video" `kind`.

* For "file" `sourceType`, `sourceValue` must be the absolute path to a multimedia file.

* For "url" `sourceType`, `sourceValue` must be the URL of an HTTP stream.

#### `track.data.format` (optional)

Valid for "device" `sourceType`. Specifies the device format used by ffmpeg.

* Default values for **Darwin** platform:
  - "avfoundation" for "audio" `kind`.
  - "avfoundation" for "video" `kind`.

* Default values for **Linux** platform:
  - "alsa" for "audio" `kind`.
  - "v4f2" for "video" `kind`.

#### `track.data.options` (optional)

Valid for "device" `sourceType`. Specifies the device options used by ffmpeg.

* Default values for **Darwin** platform:
  - `{}` for "audio" `kind`.
  - `{"framerate": "30", "video_size": "640x480"}` for "video" `kind`.

* Default values for **Linux** platform:
  - `{}` for "audio" `kind`.
  - `{"framerate": "30", "video_size": "640x480"}` for "video" `kind`.

```javascript
import { FakeMediaStreamTrack } from 'fake-mediastreamtrack';

// Create a track associated to the system default microphone.
const track = new FakeMediaStreamTrack({
  kind: 'audio',
  data: {
    sourceType: 'device'
  }
});

const audioProducer = await transport.produce({ track });
```


## Authors

* José Luis Millán [[github](https://github.com/jmillan/)]
* Iñaki Baz Castillo [[website](https://inakibaz.me)|[github](https://github.com/ibc/)]


## License

[ISC](./LICENSE)
